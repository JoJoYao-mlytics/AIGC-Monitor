# CMoney AIGC E2E 測試說明

## 📝 測試概述

本測試驗證 **CMoney 投資網站**（www.cmoney.tw）的 AIGC 功能完整流程，從新聞快訊文章到 AIGC Answer 頁面。

## 🎯 測試目標

完整驗證以下 AIGC 功能流程（12 個步驟）：

| 步驟 | 驗證項目 | 截圖 |
|------|---------|------|
| 1 | 新聞快訊頁面載入 | `01-articles-list.png` |
| 2 | 滾動頁面載入文章 | - |
| 3 | 點擊新聞文章 | `02-article-clicked.png` |
| 4 | 文章標題驗證 | - |
| 5 | 滾動載入 AIGC 區塊 | - |
| 6 | 找到「你可能想知道」區塊 | `03-aigc-section-found.png` |
| 7 | 點擊 AIGC 問題連結 | `04-answer-page-opened.png` |
| 8 | Answer 頁面標題與內容驗證 | `05-answer-content.png` |
| 9 | 滾動 Answer 頁面 | - |
| 10 | 驗證「資料來源」區塊 | `06-data-source-section.png` |
| 11 | 驗證底部 AI 推薦區塊 | `07-bottom-aigc-section.png` |
| 12 | 完整頁面與網路日誌 | `08-answer-complete.png` |

## 🔍 網路監控

測試會監控並記錄以下資源：

- ✅ **Mlytics CDN** (`mlytics.com`)
  - RUM (Real User Monitoring) 腳本
  - IMC (Interactive Media Content) 服務
  - 其他 CDN 資源

- ✅ **AIGC 服務** (`aigc`)
  - AIGC API 請求
  - AIGC Answer 頁面
  - AIGC 相關腳本與資源

網路日誌會儲存為 `network-cmoney-aigc.json`，包含：
- 請求方法 (GET, POST)
- 完整 URL
- HTTP 狀態碼
- 資源類型 (script, xhr, fetch, document)

## 📸 截圖說明

### 1. 文章列表頁 (`01-articles-list.png`)
- 新聞快訊頁面
- 顯示多篇文章標題
- 驗證頁面正確載入

### 2. 文章頁面 (`02-article-clicked.png`)
- 點擊文章後的頁面
- 顯示文章標題與內容
- 驗證導航正確

### 3. AIGC 區塊 (`03-aigc-section-found.png`)
- 文章底部的「你可能想知道」區塊
- 顯示 AIGC 生成的問題列表
- 驗證 AIGC widget 正常載入

### 4. Answer 頁面開啟 (`04-answer-page-opened.png`)
- AIGC Answer 頁面初始狀態
- 顯示問題標題
- 驗證新分頁開啟正確

### 5. Answer 內容 (`05-answer-content.png`)
- Answer 頁面的主要內容
- AI 生成的回答內容
- 驗證內容正確顯示

### 6. 資料來源區塊 (`06-data-source-section.png`)
- 顯示「資料來源」或 "Data Source"
- 列出參考資料連結
- 驗證引用來源透明度

### 7. 底部 AI 區塊 (`07-bottom-aigc-section.png`)
- 底部的「你可能想知道」或相關問題區塊
- 顯示延伸問題列表
- 驗證用戶引導功能

### 8. 完整頁面 (`08-answer-complete.png`)
- Answer 頁面的完整截圖
- 包含所有區塊
- 最終驗證完整性

## 🚀 執行測試

### 快速執行

```bash
# 執行 CMoney 測試
npm run test:cmoney

# 以 UI 模式執行（可視化）
npx playwright test tests/sites/cmoney.spec.ts --ui

# Headed 模式（顯示瀏覽器）
npx playwright test tests/sites/cmoney.spec.ts --headed

# Debug 模式（逐步執行）
npx playwright test tests/sites/cmoney.spec.ts --debug
```

### 查看結果

```bash
# 查看 HTML 報告
npm run report

# 或直接開啟
npx playwright show-report
```

## 📊 測試報告

測試完成後會產生：

1. **截圖檔案** - 8 張截圖記錄完整流程
2. **網路日誌** - `network-cmoney-aigc.json`
3. **HTML 報告** - `playwright-report/index.html`
4. **Console 輸出** - 詳細的步驟日誌

## ✅ 成功標準

測試通過需滿足以下條件：

### 必要條件 (Hard Assertions)
- ✅ 頁面 URL 包含 `cmoney.tw`
- ✅ 文章頁面標題不為空
- ✅ 找到「你可能想知道」區塊
- ✅ Answer 頁面 URL 包含 `aigc` 或 `cmoney.tw`
- ✅ 找到「資料來源」區塊
- ✅ 找到底部 AI 推薦區塊
- ✅ 頁面內容元素 > 5 個
- ✅ Mlytics 資源載入數 > 0
- ✅ AIGC 資源載入數 > 0

### 軟斷言 (Soft Assertions)
- 文章標題與連結文字相關
- Answer 標題與問題文字相關

## 🔧 測試配置

```typescript
// 超時設定
timeout: 60_000              // 整體測試：60秒
actionTimeout: 15_000        // 操作超時：15秒
navigationTimeout: 30_000    // 導航超時：30秒

// 等待時間
頁面載入: 3000ms
滾動間隔: 800-1000ms
內容等待: 1000-2000ms
```

## 🐛 常見問題

### Q: 找不到文章連結？
**A:** 測試使用多種選擇器策略：
1. 尋找 `/notes/note-detail.aspx` 路徑的連結
2. 尋找 `article a` 或 `.article-item a` 元素
3. 如果頁面結構改變，可能需要更新選擇器

### Q: AIGC 區塊沒有出現？
**A:** AIGC widget 是 lazy-loaded，測試會：
- 滾動頁面 5 次以觸發載入
- 等待 15 秒超時
- 檢查頁面是否包含 AIGC 腳本

### Q: Answer 頁面找不到資料來源？
**A:** 測試會在兩個位置尋找：
1. 主頁面中的「資料來源」文字
2. iframe 中的「資料來源」或 "Data Source" 文字

### Q: 網路請求數量為 0？
**A:** 檢查：
- 網路連線狀態
- 防火牆或廣告攔截器設定
- 確認 mlytics.com 和 AIGC 域名可訪問

### Q: 測試超時？
**A:** 可能原因：
- 網路速度慢
- 頁面載入時間長
- AIGC 服務響應慢

解決方法：
- 增加 `waitForTimeout` 時間
- 檢查網路連線
- 稍後重試

## 📝 測試流程圖

```
┌─────────────────────────────────────────────────────────────┐
│  1. 導航到新聞快訊頁面                                        │
│     https://www.cmoney.tw/notes/?navId=twstock_news         │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 滾動頁面以載入文章內容                                    │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 點擊第一篇文章 → 開啟文章頁面                             │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 驗證文章標題與連結文字相符                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 滾動到底部以觸發 AIGC widget 載入                         │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 找到「你可能想知道」區塊                                  │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  7. 點擊第一個 AIGC 問題 → 開啟新分頁                         │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  8. 驗證 Answer 頁面標題與問題相符                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  9. 滾動 Answer 頁面以載入完整內容                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 10. 驗證「資料來源」區塊存在                                  │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 11. 驗證底部「你可能想知道」或 AI 相關區塊                    │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 12. 儲存網路日誌與統計資訊                                    │
│     - Mlytics 請求數                                         │
│     - AIGC 請求數                                            │
│     - 總請求數                                               │
└─────────────────────────────────────────────────────────────┘
```

## 🌐 相關連結

- **CMoney 網站**: https://www.cmoney.tw/
- **新聞快訊**: https://www.cmoney.tw/notes/?navId=twstock_news
- **AIGC Answer**: https://aigc-note.cmoney.tw/
- **Playwright 文件**: https://playwright.dev/

## 📅 最後更新

- **日期**: 2025-10-19
- **版本**: 2.0.0
- **更新內容**: 
  - 完全重寫測試流程，直接導航到新聞快訊頁面
  - 優化選擇器策略，提高測試穩定性
  - 新增詳細的步驟日誌輸出
  - 改進網路資源監控
  - 新增 iframe 支援以尋找嵌入內容
  - 改進截圖命名與組織
  - 新增彈性的文字匹配驗證

## 👥 維護者

- AIGC Team
- QA Team

